<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Rounds">
<meta name="theme-color" content="#0d0d0d">
<title>Rounds</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0d0d; --bg2:#141414; --surf:#1c1c1c; --surf2:#252525; --surf3:#2e2e2e;
  --brd:#333; --brd2:#404040;
  --tx:#f0ede8; --tx2:#888; --tx3:#555;
  --am:#f59e0b; --am-d:rgba(245,158,11,.13); --am-g:rgba(245,158,11,.3);
  --or:#ea580c; --gn:#22c55e; --gn-d:rgba(34,197,94,.13);
  --rd:#ef4444; --rd-d:rgba(239,68,68,.13);
  --r:13px; --rl:18px; --rxl:24px;
  --st:env(safe-area-inset-top,0px); --sb:env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100dvh;font-size:15px;line-height:1.5;-webkit-font-smoothing:antialiased;overflow-x:hidden}

/* LOADING */
#ld{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:9999}
.ll{font-family:'Syne',sans-serif;font-size:2.6rem;font-weight:800;letter-spacing:-.04em}.ll b{color:var(--am)}
.sp{width:22px;height:22px;border:2.5px solid var(--brd2);border-top-color:var(--am);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* SCREENS */
.sc{display:none}
.sc.on{display:flex;flex-direction:column;min-height:100dvh}

/* AUTH */
#sa{background:var(--bg);justify-content:center;align-items:center;padding:32px 20px;min-height:100dvh;position:relative;overflow:hidden}
.ag{position:absolute;inset:0;pointer-events:none;background:radial-gradient(500px at 20% 10%,rgba(245,158,11,.07),transparent 60%),radial-gradient(400px at 85% 90%,rgba(234,88,12,.05),transparent 55%)}
.ai{width:100%;max-width:400px;position:relative;z-index:1}
.abl{font-family:'Syne',sans-serif;font-size:2.4rem;font-weight:800;letter-spacing:-.04em;text-align:center;margin-bottom:4px}.abl b{color:var(--am)}
.abs{color:var(--tx2);font-size:.88rem;text-align:center;margin-bottom:32px}
.abox{background:var(--surf);border:1px solid var(--brd);border-radius:var(--rxl);padding:24px;box-shadow:0 24px 60px rgba(0,0,0,.5)}
.seg{display:flex;background:var(--bg2);border-radius:10px;padding:3px;margin-bottom:20px}
.sb2{flex:1;padding:9px;border:none;background:none;color:var(--tx2);font-family:'Outfit',sans-serif;font-size:.88rem;font-weight:600;border-radius:8px;cursor:pointer;transition:all .18s}
.sb2.on{background:var(--am);color:#000}

/* INPUTS */
.fl{display:block;font-size:.72rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px}
.inp{width:100%;background:var(--bg2);border:1.5px solid var(--brd);border-radius:var(--r);padding:12px 14px;font-family:'Outfit',sans-serif;font-size:.93rem;color:var(--tx);outline:none;transition:border-color .15s,box-shadow .15s}
.inp:focus{border-color:var(--am);box-shadow:0 0 0 3px var(--am-d)}
.inp::placeholder{color:var(--tx3)}
.iw{margin-bottom:12px}
textarea.inp{resize:none;line-height:1.6}
input[type="datetime-local"].inp{color-scheme:dark}
.fi .inp{background:var(--bg2)}
.er{color:var(--rd);font-size:.82rem;margin-top:8px;padding:8px 12px;background:var(--rd-d);border-radius:8px;display:none}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 18px;border-radius:var(--r);border:none;cursor:pointer;font-family:'Outfit',sans-serif;font-size:.93rem;font-weight:600;transition:all .15s;text-decoration:none;white-space:nowrap;line-height:1}
.btn:active{transform:scale(.96)}
.bw{width:100%}
.ba{background:var(--am);color:#000}.ba:hover{background:#fbbf24}
.bg_{background:var(--surf2);color:var(--tx);border:1.5px solid var(--brd)}.bg_:hover{border-color:var(--am);color:var(--am)}
.br_{background:var(--rd-d);color:var(--rd);border:1.5px solid rgba(239,68,68,.25)}
.bgn{background:var(--gn-d);color:var(--gn);border:1.5px solid rgba(34,197,94,.25)}
.bsm{padding:7px 12px;font-size:.8rem;border-radius:9px}
.bxs{padding:5px 9px;font-size:.73rem;border-radius:8px}

/* APP SHELL */
#sap{background:var(--bg)}
.ah{position:sticky;top:0;z-index:100;background:rgba(13,13,13,.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--brd);padding:calc(var(--st) + 12px) 16px 12px;display:flex;align-items:center;justify-content:space-between}
.lo{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;letter-spacing:-.04em}.lo b{color:var(--am)}
.av{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--am),var(--or));display:flex;align-items:center;justify-content:center;font-size:.77rem;font-weight:800;color:#000;cursor:pointer;border:2px solid transparent;transition:border-color .2s;flex-shrink:0}
.av:hover{border-color:var(--am)}

/* NAV */
.bn{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(18,18,18,.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--brd);display:flex;padding:6px 0 calc(var(--sb) + 2px)}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;border:none;background:none;color:var(--tx3);font-family:'Outfit',sans-serif;font-size:.66rem;font-weight:600;cursor:pointer;transition:color .15s;position:relative}
.nb .ic{font-size:1.2rem;line-height:1}
.nb.on{color:var(--am)}
.nbd{position:absolute;top:3px;right:calc(50% - 18px);background:var(--am);color:#000;font-size:.57rem;font-weight:800;min-width:15px;height:15px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px}

/* TAB VIEWS */
.tv{display:none;padding:14px 14px calc(80px + var(--sb))}
.tv.on{display:block}
#tv-chat{padding:0;display:none;height:calc(100dvh - 57px - var(--st) - 64px - var(--sb))}
#tv-chat.on{display:flex;flex-direction:column}

/* UTILS */
.pt{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;letter-spacing:-.02em;margin-bottom:4px}
.ps{font-size:.82rem;color:var(--tx2);margin-bottom:18px}
.sl{font-size:.69rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--tx3);margin:0 0 8px}
.dv{height:1px;background:var(--brd);margin:14px 0}
.card{background:var(--surf);border:1px solid var(--brd);border-radius:var(--rl);padding:14px;margin-bottom:10px}
.empty{text-align:center;padding:44px 20px;color:var(--tx2)}
.empty .ei{font-size:2.6rem;margin-bottom:10px}
.empty p{font-size:.86rem;line-height:1.7}

/* FAB */
.fab{position:fixed;right:18px;bottom:calc(72px + var(--sb) + 12px);width:50px;height:50px;border-radius:50%;background:var(--am);color:#000;border:none;font-size:1.4rem;cursor:pointer;box-shadow:0 6px 20px var(--am-g);display:none;align-items:center;justify-content:center;z-index:90;transition:transform .15s}
.fab.show{display:flex}.fab:active{transform:scale(.9)}

/* MODALS */
.ov{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);display:none;align-items:flex-end;justify-content:center}
.ov.open{display:flex}
.ov.ctr{align-items:center;padding:16px}
.sh{background:var(--surf);border-radius:var(--rxl) var(--rxl) 0 0;border:1px solid var(--brd);border-bottom:none;width:100%;max-width:520px;max-height:92dvh;overflow-y:auto;padding:18px 18px calc(18px + var(--sb));animation:slideUp .25s cubic-bezier(.32,.72,0,1)}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.hn{width:34px;height:4px;background:var(--brd2);border-radius:2px;margin:0 auto 16px}
.mt{font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:800;margin-bottom:16px;letter-spacing:-.02em}

/* EVENT CARDS */
.evc{background:var(--surf);border:1px solid var(--brd);border-radius:var(--rxl);overflow:hidden;margin-bottom:12px}
.evh{padding:16px;background:linear-gradient(135deg,var(--am-d),rgba(234,88,12,.06));border-bottom:1px solid var(--brd);position:relative}
.evh::after{content:'üç∫';position:absolute;right:14px;top:12px;font-size:1.6rem;opacity:.4}
.evn{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:6px}
.evcs{display:flex;flex-wrap:wrap;gap:5px}
.evch{display:inline-flex;align-items:center;gap:3px;background:rgba(255,255,255,.06);border:1px solid var(--brd2);border-radius:20px;padding:3px 9px;font-size:.73rem;color:var(--tx2)}
.evb{padding:14px 16px}
.evdesc{font-size:.84rem;color:var(--tx2);margin-bottom:12px;line-height:1.6}
.rvw{display:flex;gap:7px;margin-bottom:10px}
.rv{flex:1;padding:9px 4px;border-radius:10px;border:1.5px solid var(--brd2);background:var(--surf2);color:var(--tx2);font-family:'Outfit',sans-serif;font-size:.77rem;font-weight:600;cursor:pointer;transition:all .15s;text-align:center}
.rv:active{transform:scale(.94)}
.rv.yes.on{background:var(--gn-d);border-color:var(--gn);color:var(--gn)}
.rv.maybe.on{background:var(--am-d);border-color:var(--am);color:var(--am)}
.rv.no.on{background:var(--rd-d);border-color:var(--rd);color:var(--rd)}
.evby{font-size:.73rem;color:var(--tx3)}

/* CHAT LAYOUT */
.chat-shell{position:relative;flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0}

/* Room list */
.clist{display:flex;flex-direction:column;height:100%;min-height:0}
.clhdr{padding:14px 14px 10px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.cltitle{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700}
.clscroll{flex:1;overflow-y:auto;padding:8px}
.cri{display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:var(--r);cursor:pointer;transition:background .12s}
.cri:hover,.cri.act{background:var(--surf2)}
.cricon{width:42px;height:42px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--am-d),rgba(234,88,12,.15));border:1.5px solid var(--brd2);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.cricon.dm{background:linear-gradient(135deg,var(--am),var(--or));font-size:.73rem;font-weight:800;color:#000}
.crinfo{flex:1;min-width:0}
.crn{font-weight:600;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.crprev{font-size:.76rem;color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.crtm{font-size:.69rem;color:var(--tx3);flex-shrink:0}

/* Chat room pane */
.crpane{display:none;flex-direction:column;position:absolute;inset:0;background:var(--bg);z-index:20}
.crpane.open{display:flex}
.crphdr{padding:11px 14px;background:rgba(13,13,13,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px;flex-shrink:0}
.cback{background:none;border:none;color:var(--tx2);font-size:1.4rem;cursor:pointer;padding:2px 6px;line-height:1}
.crhname{font-weight:700;font-size:.93rem}
.crhsub{font-size:.73rem;color:var(--tx2);margin-top:1px}
.msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:8px}
.mr{display:flex;gap:7px;align-items:flex-end}
.mr.me{flex-direction:row-reverse}
.mava{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--am),var(--or));display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;color:#000;flex-shrink:0}
.mcol{max-width:70%}
.mname{font-size:.69rem;color:var(--tx2);font-weight:600;margin-bottom:2px}
.mbub{background:var(--surf2);border:1px solid var(--brd);border-radius:14px 14px 14px 3px;padding:8px 12px;font-size:.88rem;line-height:1.5;word-break:break-word}
.mr.me .mbub{background:var(--am);color:#000;border-radius:14px 14px 3px 14px;border-color:var(--am)}
.mtime{font-size:.63rem;color:var(--tx3);margin-top:2px}
.mr.me .mtime{text-align:right;color:rgba(0,0,0,.4)}
.cinput{padding:10px 12px;background:var(--surf);border-top:1px solid var(--brd);display:flex;gap:8px;align-items:center;flex-shrink:0;padding-bottom:calc(10px + var(--sb))}
.cinp{flex:1;background:var(--surf2);border:1.5px solid var(--brd);border-radius:22px;padding:10px 15px;font-family:'Outfit',sans-serif;font-size:.9rem;color:var(--tx);outline:none;transition:border-color .15s}
.cinp:focus{border-color:var(--am)}
.cinp::placeholder{color:var(--tx3)}
.sndbtn{width:40px;height:40px;border-radius:50%;background:var(--am);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;transition:transform .15s;color:#000}
.sndbtn:active{transform:scale(.88)}

/* FRIENDS */
.fri{display:flex;align-items:center;gap:11px;padding:12px 13px;background:var(--surf);border:1px solid var(--brd);border-radius:var(--rl);margin-bottom:8px}
.fra{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--am),var(--or));display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:800;color:#000;flex-shrink:0}
.frin{flex:1;min-width:0}
.frn{font-weight:600;font-size:.9rem}
.fre{font-size:.76rem;color:var(--tx2);margin-top:1px}
.frbtns{display:flex;gap:5px;flex-shrink:0}
.srch{position:relative;margin-bottom:12px}
.srch input{width:100%;background:var(--surf);border:1.5px solid var(--brd);border-radius:var(--r);padding:11px 14px 11px 38px;font-family:'Outfit',sans-serif;font-size:.9rem;color:var(--tx);outline:none;transition:border-color .15s}
.srch input:focus{border-color:var(--am)}
.srch input::placeholder{color:var(--tx3)}
.srch::before{content:'üîç';position:absolute;left:11px;top:50%;transform:translateY(-52%);font-size:.83rem;pointer-events:none}

/* GROUP PICKER */
.mpc{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;min-height:28px}
.mch{display:inline-flex;align-items:center;gap:4px;background:var(--am-d);border:1px solid var(--am);color:var(--am);border-radius:20px;padding:3px 9px;font-size:.76rem;font-weight:600;cursor:pointer}
.fpl{display:flex;flex-direction:column;gap:5px;max-height:180px;overflow-y:auto}
.fpi{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:var(--r);border:1.5px solid var(--brd);background:var(--surf2);cursor:pointer;transition:all .12s}
.fpi.sel{border-color:var(--am);background:var(--am-d)}
.fpia{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--am),var(--or));display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:800;color:#000;flex-shrink:0}
.fpinm{font-size:.86rem;font-weight:500;flex:1}
.fpck{color:var(--am)}

/* PHOTOS */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;border-radius:var(--r);overflow:hidden;margin-bottom:8px}
.pcell{aspect-ratio:1;overflow:hidden;position:relative;background:var(--surf2)}
.pcell img{width:100%;height:100%;object-fit:cover;display:block}
.pdel{position:absolute;top:5px;right:5px;width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,.75);border:1.5px solid rgba(255,255,255,.2);color:white;font-size:.75rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:2}
.pdel:active{transform:scale(.9)}

/* MAP */
#mframe{width:100%;height:270px;border-radius:var(--rl);overflow:hidden;border:1px solid var(--brd);background:var(--surf2);margin-bottom:12px}
#mframe iframe{width:100%;height:100%;border:0}
.mempty{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--tx2);font-size:.85rem}
.mempty .ei{font-size:2.4rem}

/* PROFILE */
.prof-hdr{display:flex;align-items:center;gap:14px;margin-bottom:18px}
.prof-av{width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,var(--am),var(--or));display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;color:#000}
.prof-nm{font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:700}
.prof-em{font-size:.8rem;color:var(--tx2);margin-top:2px}

/* TOAST */
.toast{position:fixed;top:calc(var(--st) + 68px);left:50%;transform:translateX(-50%) translateY(-8px);background:var(--surf3);color:var(--tx);border:1px solid var(--brd2);padding:9px 16px;border-radius:50px;font-size:.83rem;font-weight:500;opacity:0;transition:all .22s;pointer-events:none;z-index:9998;white-space:nowrap;box-shadow:0 6px 24px rgba(0,0,0,.5)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

@media(min-width:600px){.tv,.ah{max-width:600px;margin-left:auto;margin-right:auto}.bn{justify-content:center}.nb{max-width:80px}}

/* BADGES */
.bdg-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.bdg-item{background:var(--surf2);border:1.5px solid var(--brd);border-radius:var(--rl);padding:12px 8px;text-align:center;position:relative;transition:border-color .15s}
.bdg-item.earned{border-color:var(--am);background:var(--am-d)}
.bdg-item.earned .bdg-lock{display:none}
.bdg-item:not(.earned) .bdg-icon{filter:grayscale(1);opacity:.3}
.bdg-icon{font-size:1.8rem;display:block;margin-bottom:4px}
.bdg-name{font-size:.69rem;font-weight:700;color:var(--tx2)}
.bdg-item.earned .bdg-name{color:var(--am)}
.bdg-lock{position:absolute;top:6px;right:8px;font-size:.7rem;color:var(--tx3)}
.chal-item{background:var(--surf);border:1px solid var(--brd);border-radius:var(--r);padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.chal-icon{font-size:1.5rem;flex-shrink:0}
.chal-info{flex:1}
.chal-name{font-weight:600;font-size:.88rem}
.chal-desc{font-size:.76rem;color:var(--tx2);margin-top:2px}
.chal-prog{height:5px;background:var(--brd);border-radius:3px;margin-top:6px;overflow:hidden}
.chal-prog-bar{height:100%;background:var(--am);border-radius:3px;transition:width .5s}

/* REACTIONS */
.react-bar{display:flex;gap:3px;margin-top:4px;flex-wrap:wrap}
.react-btn{background:var(--surf2);border:1px solid var(--brd);border-radius:20px;padding:2px 7px;font-size:.73rem;cursor:pointer;transition:all .12s;display:inline-flex;align-items:center;gap:2px;color:var(--tx2)}
.react-btn.mine{background:var(--am-d);border-color:var(--am);color:var(--am)}
.react-btn:active{transform:scale(.9)}
.react-picker{position:absolute;bottom:calc(100% + 4px);left:0;background:var(--surf3);border:1px solid var(--brd2);border-radius:20px;padding:4px 8px;display:none;gap:4px;z-index:50;box-shadow:0 4px 20px rgba(0,0,0,.5)}
.react-picker.open{display:flex}
.react-pick-btn{background:none;border:none;font-size:1.1rem;cursor:pointer;padding:2px;border-radius:8px;transition:transform .1s}
.react-pick-btn:active{transform:scale(1.3)}
.mr{position:relative}

/* EVENT COUNTDOWN & CHAT */
.ev-countdown{font-family:'Syne',sans-serif;font-size:.82rem;font-weight:700;color:var(--am);background:var(--am-d);border:1px solid var(--am-g);border-radius:8px;padding:4px 10px;display:inline-block;margin-top:6px}
.ev-chat-btn{margin-top:8px}

/* LIVE LOCATION */
.loc-dot{width:10px;height:10px;border-radius:50%;background:var(--gn);box-shadow:0 0 0 0 rgba(34,197,94,.4);animation:pulse-loc 1.5s infinite;display:inline-block;margin-right:4px}
@keyframes pulse-loc{0%{box-shadow:0 0 0 0 rgba(34,197,94,.5)}70%{box-shadow:0 0 0 8px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
.loc-item{background:var(--surf);border:1px solid var(--brd);border-radius:var(--r);padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px}
.loc-name{font-weight:600;font-size:.88rem;flex:1}
.loc-coords{font-size:.73rem;color:var(--tx2)}

/* PUSH NOTIFICATION BANNER */
.pnb{position:fixed;top:calc(var(--st) + 8px);left:8px;right:8px;max-width:420px;margin:0 auto;background:var(--surf3);border:1px solid var(--brd2);border-radius:16px;padding:12px 14px;display:flex;align-items:center;gap:10px;z-index:9997;box-shadow:0 8px 32px rgba(0,0,0,.6);transform:translateY(-120%);transition:transform .3s cubic-bezier(.32,.72,0,1);cursor:pointer}
.pnb.show{transform:translateY(0)}
.pnb-icon{font-size:1.4rem;flex-shrink:0}
.pnb-body{flex:1;min-width:0}
.pnb-title{font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pnb-msg{font-size:.75rem;color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.pnb-close{color:var(--tx3);font-size:1rem;flex-shrink:0;background:none;border:none;cursor:pointer;padding:2px}

/* PROFILE PHOTO */
.prof-av-wrap{position:relative;cursor:pointer}
.prof-av-wrap:hover::after{content:'‚úèÔ∏è';position:absolute;bottom:-2px;right:-2px;font-size:.75rem;background:var(--surf2);border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border:1px solid var(--brd)}
.prof-av img{width:100%;height:100%;border-radius:50%;object-fit:cover}

/* UNREAD BADGE */
.unread-dot{width:8px;height:8px;border-radius:50%;background:var(--am);flex-shrink:0}
.crn-wrap{display:flex;align-items:center;gap:5px}
.unread-count{background:var(--am);color:#000;font-size:.63rem;font-weight:800;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 4px;flex-shrink:0}

/* RSVP LIST MODAL */
.rsvp-user{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--brd)}
.rsvp-user:last-child{border-bottom:none}
.rsvp-av{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--am),var(--or));display:flex;align-items:center;justify-content:center;font-size:.73rem;font-weight:800;color:#000;flex-shrink:0}
.rsvp-nm{flex:1;font-size:.88rem;font-weight:600}
.rsvp-status{font-size:.8rem}

/* VIDEO */
.pcell video{width:100%;height:100%;object-fit:cover}
.media-type-badge{position:absolute;bottom:5px;left:5px;background:rgba(0,0,0,.7);color:white;font-size:.6rem;padding:1px 5px;border-radius:4px;font-weight:700}

/* COPYRIGHT */
.copy-footer{text-align:center;padding:8px 16px calc(10px + var(--sb));font-size:.65rem;color:var(--tx3);letter-spacing:.03em}

/* DELETE BUTTON ON EVENTS */
.ev-del-btn{background:none;border:none;color:var(--tx3);font-size:.75rem;cursor:pointer;padding:2px 6px;border-radius:6px;transition:color .12s;margin-left:auto}
.ev-del-btn:hover{color:var(--rd)}

/* FRIEND-ONLY WALL */
#friendwall{display:none;position:fixed;inset:0;background:var(--bg);z-index:8000;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;text-align:center}
#friendwall.show{display:flex}
.fw-icon{font-size:3.5rem;margin-bottom:16px}
.fw-title{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:800;margin-bottom:8px}
.fw-sub{font-size:.88rem;color:var(--tx2);line-height:1.7;margin-bottom:24px}
</style>
</head>
<body>

<!-- PUSH NOTIFICATION BANNER -->
<div class="pnb" id="pnbanner" onclick="pnClick()">
  <div class="pnb-icon" id="pnicon">üí¨</div>
  <div class="pnb-body">
    <div class="pnb-title" id="pntitle">Nieuw bericht</div>
    <div class="pnb-msg" id="pnmsg"></div>
  </div>
  <button class="pnb-close" onclick="event.stopPropagation();hidePNB()">‚úï</button>
</div>

<!-- FRIEND WALL (shown to strangers) -->
<div id="friendwall">
  <div class="fw-icon">üîí</div>
  <div class="fw-title">Besloten crew</div>
  <div class="fw-sub">Deze app is alleen voor mensen die door een lid zijn uitgenodigd. Vraag een vriend om je toe te voegen via je e-mailadres!</div>
  <button class="btn ba" onclick="doLogout()">Uitloggen</button>
</div>

<!-- LOADING -->
<div id="ld"><div class="ll">Rounds<b>.</b></div><div class="sp"></div></div>

<!-- AUTH -->
<div class="sc" id="sa">
  <div class="ag"></div>
  <div class="ai">
    <div class="abl">Rounds<b>.</b></div>
    <div class="abs">Afspreken met je crew üç∫</div>
    <div class="abox">
      <div class="seg">
        <button class="sb2 on" onclick="authTab('login')">Inloggen</button>
        <button class="sb2" onclick="authTab('register')">Registreren</button>
      </div>
      <div id="aplogin">
        <div class="iw"><label class="fl">E-mailadres</label><input class="inp" type="email" id="liem" placeholder="jij@email.com" autocomplete="email"></div>
        <div class="iw"><label class="fl">Wachtwoord</label><input class="inp" type="password" id="lipw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
        <button class="btn ba bw" onclick="doLogin()">Inloggen ‚Üí</button>
        <div class="er" id="lier"></div>
      </div>
      <div id="apreg" style="display:none">
        <div class="iw"><label class="fl">Naam</label><input class="inp" type="text" id="rgnm" placeholder="Quinten" autocomplete="name"></div>
        <div class="iw"><label class="fl">E-mailadres</label><input class="inp" type="email" id="rgem" placeholder="jij@email.com" autocomplete="email"></div>
        <div class="iw"><label class="fl">Wachtwoord</label><input class="inp" type="password" id="rgpw" placeholder="Min. 6 tekens" autocomplete="new-password"></div>
        <button class="btn ba bw" onclick="doRegister()">Account aanmaken ‚Üí</button>
        <div class="er" id="rger"></div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="sc" id="sap">
  <header class="ah">
    <div class="lo">Rounds<b>.</b></div>
    <div class="av" id="hav" onclick="openModal('moprof')">?</div>
  </header>

  <!-- HOME -->
  <div class="tv on" id="tv-home">
    <div class="pt" id="greet">Hey üëã</div>
    <div class="ps">Wat staat er op de planning?</div>
    <div class="sl">Aankomende events</div>
    <div id="evl"><div class="empty"><div class="ei">üç∫</div><p>Nog geen events.<br>Tik + om er een aan te maken!</p></div></div>
    <div class="dv"></div>
    <div class="sl">Live locaties üì°</div>
    <div id="liveloc-list"><div style="font-size:.8rem;color:var(--tx2);padding:8px 0">Niemand deelt momenteel een locatie.</div></div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn bg_ bsm" id="shareloc-btn" onclick="toggleShareLocation()">üìç Locatie delen</button>
      <button class="btn br_ bsm" id="stoploc-btn" style="display:none" onclick="stopShareLocation()">‚úï Stop delen</button>
    </div>
    <div class="copy-footer">¬© Quinten De Smet 2026</div>
  </div>

  <!-- CHAT -->
  <div class="tv" id="tv-chat">
    <div class="chat-shell">
      <!-- Room list -->
      <div class="clist" id="clistpane">
        <div class="clhdr">
          <div class="cltitle">Gesprekken</div>
          <button class="btn bg_ bsm" onclick="openNewGroup()">+ Groep</button>
        </div>
        <div class="clscroll" id="roomlist">
          <div class="empty" style="padding:30px 10px"><div class="ei" style="font-size:2rem">üí¨</div><p>Voeg vrienden toe om te chatten!</p><button class="btn ba bsm" style="margin-top:12px" onclick="goTab('friends')">üë• Vrienden toevoegen</button></div>
        </div>
      </div>
      <!-- Chat room -->
      <div class="crpane" id="crpane">
        <div class="crphdr">
          <button class="cback" onclick="closeRoom()">‚Äπ</button>
          <div>
            <div class="crhname" id="roomname">‚Äî</div>
            <div class="crhsub" id="roomsub"></div>
          </div>
        </div>
        <div class="msgs" id="msglist"></div>
        <div class="cinput">
          <input class="cinp" id="msginput" placeholder="Typ een bericht..." autocomplete="off">
          <button class="sndbtn" id="sndbtn">‚û§</button>
        </div>
      </div>
    </div>
  </div>


  <!-- MAP - shows locations from events -->
  <div class="tv" id="tv-map">
    <div class="pt">Locaties</div>
    <div class="ps">Kaarten van aankomende events</div>
    <div id="evmaplist"><div class="empty"><div class="ei">üìç</div><p>Nog geen events met locatie.<br>Maak een event aan!</p></div></div>
  </div>

  <!-- FRIENDS -->
  <div class="tv" id="tv-friends">
    <div class="pt">Vrienden</div>
    <div class="ps">Vind en beheer je crew</div>
    <div class="srch"><input type="email" id="frsearch" placeholder="Zoek op e-mailadres..."></div>
    <button class="btn ba bw" style="margin-bottom:18px" onclick="searchFriend()">Vriend zoeken</button>
    <div id="frreqsec" style="display:none">
      <div class="sl">Verzoeken üîî</div>
      <div id="frreqlist"></div>
      <div class="dv"></div>
    </div>
    <div class="sl">Mijn vrienden</div>
    <div id="frlist"><div class="empty"><div class="ei">üë•</div><p>Nog geen vrienden.<br>Zoek iemand op via e-mail!</p></div></div>
  </div>

  <!-- PHOTOS -->
  <div class="tv" id="tv-photos">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div><div class="pt">Media</div><div class="ps" style="margin:0">Foto's & video's van de crew</div></div>
      <label style="cursor:pointer"><input type="file" accept="image/*,video/*" id="phoinput" style="display:none" onchange="uploadPhoto(this)"><span class="btn ba bsm">+ Media</span></label>
    </div>
    <div class="pgrid" id="photogrid"></div>
    <div id="phoempty" class="empty"><div class="ei">üì∏</div><p>Nog geen media.<br>Voeg de eerste toe!</p></div>
  </div>

  <nav class="bn">
    <button class="nb on" id="nb-home" onclick="goTab('home')"><span class="ic">üè†</span>Home</button>
    <button class="nb" id="nb-chat" onclick="goTab('chat')"><span class="ic">üí¨</span>Chat<span class="nbd" id="chatbadge" style="display:none">0</span></button>
    <button class="nb" id="nb-map" onclick="goTab('map')"><span class="ic">üìç</span>Map</button>
    <button class="nb" id="nb-friends" onclick="goTab('friends')"><span class="ic">üë•</span>Vrienden</button>
    <button class="nb" id="nb-photos" onclick="goTab('photos')"><span class="ic">üì∏</span>Media</button>
  </nav>
</div>

<!-- FAB goes to event create page -->
<button class="fab" id="fab" onclick="openEventPage()">+</button>

<!-- FULL SCREEN EVENT CREATE PAGE -->
<div id="evpage" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:300;overflow-y:auto;padding:calc(var(--st) + 16px) 18px calc(var(--sb) + 24px);">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;">
    <button onclick="closeEventPage()" style="background:var(--surf2);border:1px solid var(--brd);color:var(--tx);width:38px;height:38px;border-radius:50%;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">‚Äπ</button>
    <div style="font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;">Nieuw event</div>
  </div>

  <div id="evpage-err" style="display:none;background:var(--rd-d);border:1px solid rgba(239,68,68,.4);color:var(--rd);border-radius:12px;padding:12px 14px;font-size:.87rem;margin-bottom:16px;"></div>

  <div style="margin-bottom:14px;">
    <label style="display:block;font-size:.72rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;">Naam *</label>
    <input id="ep-name" type="text" placeholder="bijv. Vrijdagavond uit!"
      style="width:100%;background:var(--surf);border:1.5px solid var(--brd);border-radius:13px;padding:13px 15px;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--tx);outline:none;">
  </div>

  <div style="margin-bottom:14px;">
    <label style="display:block;font-size:.72rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;">Datum & tijd *</label>
    <input id="ep-date" type="datetime-local"
      style="width:100%;background:var(--surf);border:1.5px solid var(--brd);border-radius:13px;padding:13px 15px;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--tx);outline:none;color-scheme:dark;">
  </div>

  <div style="margin-bottom:14px;">
    <label style="display:block;font-size:.72rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;">Locatie naam</label>
    <input id="ep-loc" type="text" placeholder="bijv. Caf√© De Kroon"
      style="width:100%;background:var(--surf);border:1.5px solid var(--brd);border-radius:13px;padding:13px 15px;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--tx);outline:none;">
  </div>

  <div style="margin-bottom:14px;">
    <label style="display:block;font-size:.72rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;">Straat & nr</label>
    <input id="ep-street" type="text" placeholder="bijv. Grote Markt 1"
      style="width:100%;background:var(--surf);border:1.5px solid var(--brd);border-radius:13px;padding:13px 15px;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--tx);outline:none;">
  </div>

  <div style="margin-bottom:14px;">
    <label style="display:block;font-size:.72rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;">Stad</label>
    <input id="ep-city" type="text" placeholder="bijv. Mechelen"
      style="width:100%;background:var(--surf);border:1.5px solid var(--brd);border-radius:13px;padding:13px 15px;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--tx);outline:none;">
  </div>

  <div style="margin-bottom:28px;">
    <label style="display:block;font-size:.72rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;">Beschrijving</label>
    <textarea id="ep-desc" rows="4" placeholder="Meer info over het event..."
      style="width:100%;background:var(--surf);border:1.5px solid var(--brd);border-radius:13px;padding:13px 15px;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--tx);outline:none;resize:none;line-height:1.6;"></textarea>
  </div>

  <button id="ep-btn" onclick="submitEvent()"
    style="width:100%;background:var(--am);color:#000;border:none;border-radius:13px;padding:16px;font-family:'Outfit',sans-serif;font-size:1.05rem;font-weight:700;cursor:pointer;transition:opacity .15s;">
    üéâ Event aanmaken
  </button>
</div>

<!-- NEW GROUP MODAL -->
<div class="ov" id="mogrp">
  <div class="sh">
    <div class="hn"></div>
    <div class="mt">üë• Nieuwe groepschat</div>
    <div class="iw"><label class="fl">Groepsnaam</label><input class="inp" id="grpname" placeholder="bijv. Vrijdagbende üç∫"></div>
    <div class="iw">
      <label class="fl">Leden (selecteer vrienden)</label>
      <div class="mpc" id="grpchips"></div>
      <div class="fpl" id="grppicker"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn bg_" style="flex:0 0 auto" onclick="closeModal('mogrp')">Annuleren</button>
      <button class="btn ba" style="flex:1" onclick="createGroup()">Groep aanmaken</button>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="ov" id="moprof">
  <div class="sh">
    <div class="hn"></div>
    <div class="prof-hdr">
      <div class="prof-av-wrap" onclick="G('profphoinp').click()">
        <div class="prof-av" id="profav">?</div>
        <input type="file" accept="image/*" id="profphoinp" style="display:none" onchange="uploadProfilePhoto(this)">
      </div>
      <div>
        <div class="prof-nm" id="profnm"></div>
        <div class="prof-em" id="profem"></div>
        <div style="font-size:.72rem;color:var(--tx3);margin-top:3px">Tik op foto om te wijzigen</div>
      </div>
    </div>
    <div class="sl" style="margin-top:12px">Mijn badges üèÜ</div>
    <div class="bdg-grid" id="prof-badges"></div>
    <div class="dv"></div>
    <button class="btn bg_ bw" style="margin-bottom:8px" onclick="openModal('mochallenges');closeModal('moprof')">üéØ Challenges bekijken</button>
    <button class="btn ba bw" style="margin-bottom:8px" onclick="doLogout()">Uitloggen</button>
    <button class="btn br_ bw" onclick="confirmDeleteAccount()">üóë Account verwijderen</button>
  </div>
</div>

<!-- PHOTO VIEWER -->
<div class="ov ctr" id="mophoto" onclick="closeModal('mophoto')">
  <img id="photobig" src="" style="max-width:100%;max-height:80dvh;border-radius:var(--rl);box-shadow:0 16px 48px rgba(0,0,0,.8)">
</div>

<!-- CHALLENGES MODAL -->
<div class="ov" id="mochallenges">
  <div class="sh">
    <div class="hn"></div>
    <div class="mt">üéØ Challenges & Badges</div>
    <div id="challenges-list"></div>
  </div>
</div>

<!-- RSVP LIST MODAL -->
<div class="ov" id="morsvp">
  <div class="sh">
    <div class="hn"></div>
    <div class="mt" id="rsvp-modal-title">Aanwezigheid</div>
    <div style="display:flex;gap:6px;margin-bottom:14px">
      <button class="btn bsm" id="rsvp-tab-yes" onclick="showRsvpTab('yes')" style="background:var(--gn-d);color:var(--gn);border:1.5px solid rgba(34,197,94,.3)">‚úÖ Komen <span id="rsvp-yes-count">0</span></button>
      <button class="btn bsm" id="rsvp-tab-maybe" onclick="showRsvpTab('maybe')" style="background:var(--am-d);color:var(--am);border:1.5px solid var(--am-g)">ü§î Misschien <span id="rsvp-maybe-count">0</span></button>
      <button class="btn bsm" id="rsvp-tab-no" onclick="showRsvpTab('no')" style="background:var(--rd-d);color:var(--rd);border:1.5px solid rgba(239,68,68,.25)">‚ùå Niet <span id="rsvp-no-count">0</span></button>
    </div>
    <div id="rsvp-modal-list"></div>
  </div>
</div>

<!-- EVENT CHAT MODAL -->
<div class="ov" id="moevtchat">
  <div class="sh" style="max-height:85dvh;display:flex;flex-direction:column">
    <div class="hn"></div>
    <div class="mt" id="evtchat-title">Event Chat</div>
    <div id="evtchat-msgs" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:7px;min-height:120px;max-height:320px;padding:4px 0"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input class="cinp" id="evtchat-inp" placeholder="Typ een bericht..." style="flex:1">
      <button class="sndbtn" onclick="sendEvtChatMsg()">‚û§</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, updateProfile, setPersistence, browserLocalPersistence,
  deleteUser, EmailAuthProvider, reauthenticateWithCredential
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc,
  onSnapshot, query, orderBy, serverTimestamp,
  doc, setDoc, getDoc, updateDoc, where, limit
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
const firebaseApp = initializeApp({
  apiKey:"AIzaSyB79_lT_UeSj3WZgGUjl6FJsugK-Oa-dFM",
  authDomain:"drinking-ap.firebaseapp.com",
  projectId:"drinking-ap",
  storageBucket:"drinking-ap.firebasestorage.app",
  messagingSenderId:"869345427783",
  appId:"1:869345427783:web:4db013a00017054e2c4c62"
});
const auth = getAuth(firebaseApp);
const db   = getFirestore(firebaseApp);
setPersistence(auth, browserLocalPersistence).catch(() => {});

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let me = null;
let myFriends = [];
let activeRoomId = null;
let unsubRoom = null;
let unsubEvs = null;
let unsubRooms = null;
let selMembers = [];
let locWatchId = null;
let unsubEvtChat = null;
let activeEvtChatId = null;
let currentRsvpEvData = null;
let currentRsvpTab = 'yes';
let pnbTimeout = null;
let unsubLiveLoc = null;
let myBadges = [];

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
const G = id => document.getElementById(id);
const ini = n => n ? n.trim().split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2) : '?';
const ftm = ts => { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleTimeString('nl-BE',{hour:'2-digit',minute:'2-digit'}); };
const fdt = ts => { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleDateString('nl-BE',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}); };

const showToast = (msg, dur=2500) => {
  const t = G('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
};

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
window.openModal = id => G(id).classList.add('open');
window.closeModal = id => G(id).classList.remove('open');
document.querySelectorAll('.ov').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o && o.id !== 'mophoto') o.classList.remove('open'); });
});

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
window.authTab = tab => {
  document.querySelectorAll('.sb2').forEach((b,i) => b.classList.toggle('on', (i===0&&tab==='login')||(i===1&&tab==='register')));
  G('aplogin').style.display = tab === 'login' ? 'block' : 'none';
  G('apreg').style.display   = tab === 'register' ? 'block' : 'none';
};

const showErr = (id,msg) => { const e=G(id); e.textContent=msg; e.style.display='block'; };
const hideErr = id => G(id).style.display='none';

window.doLogin = async () => {
  hideErr('lier');
  const em = G('liem').value.trim(), pw = G('lipw').value;
  if (!em || !pw) { showErr('lier','Vul alle velden in.'); return; }
  try { await signInWithEmailAndPassword(auth, em, pw); }
  catch(e) { showErr('lier', e.code==='auth/invalid-credential' ? 'Verkeerd e-mail of wachtwoord.' : 'Fout bij inloggen.'); }
};

window.doRegister = async () => {
  hideErr('rger');
  const nm = G('rgnm').value.trim(), em = G('rgem').value.trim(), pw = G('rgpw').value;
  if (!nm || !em || !pw) { showErr('rger','Vul alle velden in.'); return; }
  if (pw.length < 6) { showErr('rger','Wachtwoord minimaal 6 tekens.'); return; }
  try {
    const c = await createUserWithEmailAndPassword(auth, em, pw);
    await updateProfile(c.user, { displayName: nm });
    await setDoc(doc(db,'users',c.user.uid), { name:nm, email:em.toLowerCase(), uid:c.user.uid, createdAt:serverTimestamp() });
  } catch(e) { showErr('rger', e.code==='auth/email-already-in-use' ? 'E-mail al in gebruik.' : 'Fout bij registreren.'); }
};

window.doLogout = async () => { await signOut(auth); closeModal('moprof'); };

/* ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ */
onAuthStateChanged(auth, async user => {
  G('ld').style.display = 'none';
  if (user) {
    me = user;

    // ‚îÄ‚îÄ FRIEND-ONLY GATE ‚îÄ‚îÄ
    // Check if user is the "owner" (has at least one accepted friend or created events)
    // Allow access if: user has friends OR is creator of at least one event OR user doc is old enough
    const userSnap = await getDoc(doc(db,'users',user.uid));
    const userData = userSnap.exists() ? userSnap.data() : null;

    // Check if new stranger: no friends yet AND account is very new (< 10 min old)
    const isNewAccount = userData?.createdAt ? (Date.now() - userData.createdAt.toDate().getTime() < 600000) : false;
    // Check if they have any friend connections
    const [fr1, fr2] = await Promise.all([
      getDocs(query(collection(db,'friendRequests'), where('from','==',user.uid), where('status','==','accepted'), limit(1))),
      getDocs(query(collection(db,'friendRequests'), where('to','==',user.uid), where('status','==','accepted'), limit(1)))
    ]);
    const hasFriends = !fr1.empty || !fr2.empty;
    // Check if they have pending friend requests (were invited)
    const hasPending = await getDocs(query(collection(db,'friendRequests'), where('to','==',user.uid), where('status','==','pending'), limit(1)));
    const wasInvited = !hasPending.empty;

    // Block pure strangers (new account, no friends, no invites)
    if (isNewAccount && !hasFriends && !wasInvited) {
      G('friendwall').classList.add('show');
      G('sa').classList.remove('on');
      G('sap').classList.remove('on');
      G('fab').classList.remove('show');
      return;
    }
    G('friendwall').classList.remove('show');

    const profilePhoto = userData?.photoURL || null;
    const i = ini(user.displayName);
    G('hav').innerHTML = profilePhoto ? `<img src="${profilePhoto}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : i;
    // Update profav
    const profAvEl = G('profav');
    if (profilePhoto) {
      profAvEl.innerHTML = `<img src="${profilePhoto}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`;
    } else {
      profAvEl.textContent = i;
    }
    G('profnm').textContent = user.displayName || '';
    G('profem').textContent = user.email || '';
    G('greet').textContent = `Hey ${user.displayName?.split(' ')[0] || 'daar'} üëã`;
    G('fab').classList.add('show');
    G('sa').classList.remove('on');
    G('sap').classList.add('on');
    try {
      await setDoc(doc(db, 'users', user.uid), { name: user.displayName || '', email: user.email || '', uid: user.uid, lastSeen: serverTimestamp() }, { merge: true });
    } catch(e) {
      setTimeout(() => showToast('‚ö†Ô∏è Firebase regels blokkeren schrijven! Publiceer de regels opnieuw.', 6000), 1000);
    }
    await loadFriends();
    startEvents();
    startRooms();
    loadPhotos();
    loadBadges();
    startLiveLocations();
    requestNotificationPermission();
  } else {
    me = null; myFriends = [];
    G('sap').classList.remove('on');
    G('sa').classList.add('on');
    G('fab').classList.remove('show');
    G('friendwall').classList.remove('show');
    if (unsubRoom)   { unsubRoom();   unsubRoom   = null; }
    if (unsubEvs)    { unsubEvs();    unsubEvs    = null; }
    if (unsubRooms)  { unsubRooms();  unsubRooms  = null; }
    if (unsubLiveLoc){ unsubLiveLoc(); unsubLiveLoc = null; }
    if (locWatchId !== null) { navigator.geolocation.clearWatch(locWatchId); locWatchId = null; }
  }
});

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
window.goTab = tab => {
  document.querySelectorAll('.tv').forEach(v => v.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b => b.classList.remove('on'));
  G('tv-' + tab).classList.add('on');
  G('nb-' + tab).classList.add('on');
  G('fab').classList.toggle('show', tab === 'home');
  if (tab === 'chat') { G('chatbadge').style.display = 'none'; closeRoom(); }
  if (tab === 'friends') loadFriends();
  if (tab === 'photos') loadPhotos();
  if (tab === 'map') renderEventMaps();
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENT CREATE PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.openEventPage = () => {
  // Set default date to 1 hour from now
  const d = new Date(Date.now() + 3600000);
  d.setSeconds(0, 0);
  const pad = n => String(n).padStart(2, '0');
  const local = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  document.getElementById('ep-date').value = local;
  document.getElementById('ep-name').value = '';
  document.getElementById('ep-loc').value = '';
  document.getElementById('ep-street').value = '';
  document.getElementById('ep-city').value = '';
  document.getElementById('ep-desc').value = '';
  document.getElementById('evpage-err').style.display = 'none';
  document.getElementById('ep-btn').disabled = false;
  document.getElementById('ep-btn').textContent = 'üéâ Event aanmaken';
  document.getElementById('evpage').style.display = 'block';
  document.getElementById('ep-name').focus();
};

window.closeEventPage = () => {
  document.getElementById('evpage').style.display = 'none';
};

window.submitEvent = async () => {
  const nameVal   = document.getElementById('ep-name').value.trim();
  const dateVal   = document.getElementById('ep-date').value;
  const locVal    = document.getElementById('ep-loc').value.trim();
  const streetVal = document.getElementById('ep-street').value.trim();
  const cityVal   = document.getElementById('ep-city').value.trim();
  const descVal   = document.getElementById('ep-desc').value.trim();
  const errEl     = document.getElementById('evpage-err');
  const btn       = document.getElementById('ep-btn');

  const showErr = msg => {
    errEl.textContent = msg;
    errEl.style.display = 'block';
    errEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  };

  errEl.style.display = 'none';

  if (!nameVal) { showErr('‚ùå Vul een naam in voor het event!'); return; }
  if (!dateVal)  { showErr('‚ùå Kies een datum en tijd!'); return; }

  const dateObj = new Date(dateVal);
  if (isNaN(dateObj.getTime())) { showErr('‚ùå Ongeldige datum!'); return; }

  let locationStr = '';
  if (locVal && streetVal && cityVal)   locationStr = `${locVal} ‚Äî ${streetVal}, ${cityVal}`;
  else if (locVal && cityVal)           locationStr = `${locVal}, ${cityVal}`;
  else if (streetVal && cityVal)        locationStr = `${streetVal}, ${cityVal}`;
  else if (locVal)                      locationStr = locVal;
  else if (cityVal)                     locationStr = cityVal;

  btn.disabled = true;
  btn.textContent = '‚è≥ Bezig...';

  try {
    const eventsRef = collection(db, 'events');
    const newDoc = await addDoc(eventsRef, {
      name:          nameVal,
      date:          dateObj,
      location:      locationStr,
      description:   descVal,
      createdBy:     me.uid,
      createdByName: me.displayName || 'Onbekend',
      rsvps:         {},
      createdAt:     serverTimestamp()
    });

    console.log('Event created:', newDoc.id);
    window.closeEventPage();
    showToast('üéâ Event aangemaakt!');
  } catch(e) {
    console.error('submitEvent FAILED:', e.code, e.message);
    showErr(`‚ùå ${e.message}`);
    btn.disabled = false;
    btn.textContent = 'üéâ Event aanmaken';
  }
};

function startEvents() {
  if (unsubEvs) unsubEvs();
  unsubEvs = onSnapshot(collection(db, 'events'), snap => {
    const evs = [];
    snap.forEach(d => evs.push({ id: d.id, ...d.data() }));
    evs.sort((a, b) => {
      const da = a.date?.toDate ? a.date.toDate() : new Date(0);
      const db2 = b.date?.toDate ? b.date.toDate() : new Date(0);
      return da - db2;
    });
    latestEvents = evs; // cache for map tab
    renderEvents(evs);
  }, e => { console.error('Events error:', e.message); });
}

function renderEvents(evs) {
  const c = G('evl');
  if (!evs.length) {
    c.innerHTML = '<div class="empty"><div class="ei">üç∫</div><p>Nog geen events.<br>Tik + om er een aan te maken!</p></div>';
    return;
  }
  c.innerHTML = evs.map(ev => {
    const rsvps = ev.rsvps || {};
    const myR   = rsvps[me?.uid] || '';
    const yesC  = Object.values(rsvps).filter(x => x === 'yes').length;
    const mayC  = Object.values(rsvps).filter(x => x === 'maybe').length;
    const dateStr = ev.date?.toDate ? fdt(ev.date) : '';
    const countdown = ev.date?.toDate ? getCountdown(ev.date.toDate()) : '';
    const canDelete = ev.createdBy === me?.uid;
    return `<div class="evc">
      <div class="evh">
        <div style="display:flex;align-items:flex-start">
          <div style="flex:1"><div class="evn">${ev.name}</div></div>
          ${canDelete ? `<button class="ev-del-btn" onclick="deleteEvent('${ev.id}')">üóë</button>` : ''}
        </div>
        <div class="evcs">
          ${dateStr ? `<span class="evch">üìÖ ${dateStr}</span>` : ''}
          ${ev.location ? `<span class="evch">üìç ${ev.location}</span>` : ''}
          <span class="evch" style="cursor:pointer" onclick="openRsvpModal('${ev.id}')" title="Klik voor lijst">‚úÖ <u>${yesC} komen</u>${mayC ? ` ¬∑ ü§î ${mayC}` : ''}</span>
        </div>
        ${countdown ? `<div class="ev-countdown">‚è± ${countdown}</div>` : ''}
      </div>
      <div class="evb">
        ${ev.description ? `<div class="evdesc">${ev.description}</div>` : ''}
        <div class="rvw">
          <button class="rv yes ${myR==='yes'?'on':''}" onclick="rsvp('${ev.id}','yes')">‚úÖ Ik kom</button>
          <button class="rv maybe ${myR==='maybe'?'on':''}" onclick="rsvp('${ev.id}','maybe')">ü§î Misschien</button>
          <button class="rv no ${myR==='no'?'on':''}" onclick="rsvp('${ev.id}','no')">‚ùå Kan niet</button>
        </div>
        <button class="btn bg_ bsm ev-chat-btn" onclick="openEvtChat('${ev.id}','${ev.name.replace(/'/g,"\\'")}')">üí¨ Event chat</button>
        <div class="evby" style="margin-top:8px">Door ${ev.createdByName || 'onbekend'}</div>
      </div>
    </div>`;
  }).join('');
}

function getCountdown(date) {
  const diff = date - Date.now();
  if (diff <= 0) return 'Bezig! üéâ';
  const d = Math.floor(diff / 86400000);
  const h = Math.floor((diff % 86400000) / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  if (d > 0) return `Nog ${d}d ${h}u`;
  if (h > 0) return `Nog ${h}u ${m}min`;
  return `Nog ${m} minuten!`;
}

window.rsvp = async (evId, status) => {
  if (!me) return;
  try {
    await updateDoc(doc(db, 'events', evId), { [`rsvps.${me.uid}`]: status });
    showToast(status==='yes' ? '‚úÖ Je bent erbij!' : status==='maybe' ? 'ü§î Misschien...' : '‚ùå Jammer!');
  } catch(e) { showToast('Fout: ' + e.message); }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startRooms() {
  if (unsubRooms) unsubRooms();
  let firstLoad = true;
  let prevLastMsgs = {};
  unsubRooms = onSnapshot(
    query(collection(db,'rooms'), where('members','array-contains', me.uid)),
    snap => {
      const rooms = [];
      snap.forEach(d => rooms.push({ id: d.id, ...d.data() }));
      rooms.sort((a, b) => {
        const ta = a.lastAt?.toDate ? a.lastAt.toDate() : new Date(0);
        const tb = b.lastAt?.toDate ? b.lastAt.toDate() : new Date(0);
        return tb - ta;
      });

      if (!firstLoad) {
        // Check for new messages from others
        rooms.forEach(r => {
          const prevMsg = prevLastMsgs[r.id];
          const curMsg  = r.lastMsg;
          const lastSenderId = r.lastSenderId;
          if (curMsg && curMsg !== prevMsg && lastSenderId && lastSenderId !== me.uid) {
            // New message from someone else
            if (r.id !== activeRoomId) {
              showPNB(r.name || 'Chat', curMsg, r.id, r.name);
            }
          }
        });
      }
      firstLoad = false;
      rooms.forEach(r => { prevLastMsgs[r.id] = r.lastMsg; });
      renderRooms(rooms);
    },
    e => { console.error('Rooms error:', e.message); }
  );
}

function renderRooms(rooms) {
  const c = G('roomlist');
  if (!rooms.length) {
    c.innerHTML = '<div class="empty" style="padding:24px 10px"><div class="ei" style="font-size:1.8rem">üí¨</div><p>Nog geen gesprekken.</p><button class="btn ba bsm" style="margin-top:12px" onclick="goTab(\'friends\')">üë• Vrienden toevoegen</button></div>';
    return;
  }
  let totalUnread = 0;
  c.innerHTML = rooms.map(r => {
    const isG = r.type === 'group';
    const name = r.name || (isG ? 'Groep' : 'DM');
    const prev = r.lastMsg || 'Nog geen berichten';
    const tm   = r.lastAt ? ftm(r.lastAt) : '';
    const unread = r.unread?.[me?.uid] || 0;
    if (unread > 0) totalUnread += unread;
    const iconHTML = isG
      ? `<div class="cricon">üë•</div>`
      : `<div class="cricon dm">${ini(r.name || '?')}</div>`;
    const safeName = name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const safeSub  = (r.memberNames||[]).join(', ').replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const unreadBadge = unread > 0 ? `<span class="unread-count">${unread}</span>` : '';
    return `<div class="cri ${r.id===activeRoomId?'act':''}" onclick="openRoom('${r.id}','${safeName}','${safeSub}')">
      ${iconHTML}
      <div class="crinfo">
        <div class="crn-wrap"><div class="crn">${name}</div></div>
        <div class="crprev" style="${unread>0?'color:var(--tx);font-weight:600':''}">${prev}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div class="crtm">${tm}</div>
        ${unreadBadge}
      </div>
    </div>`;
  }).join('');

  // Update nav badge
  const chatBadge = G('chatbadge');
  if (totalUnread > 0) {
    chatBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
    chatBadge.style.display = 'flex';
  } else {
    chatBadge.style.display = 'none';
  }
}

window.openRoom = async (id, name, sub) => {
  activeRoomId = id;
  G('roomname').textContent = name;
  G('roomsub').textContent = sub || '';
  G('msglist').innerHTML = '';
  G('crpane').classList.add('open');
  listenRoom(id);
  setTimeout(() => G('msginput').focus(), 100);
  // Clear unread for this room
  try {
    await updateDoc(doc(db,'rooms',id), { [`unread.${me.uid}`]: 0 });
  } catch(e) {}
};

window.closeRoom = () => {
  activeRoomId = null;
  G('crpane').classList.remove('open');
  if (unsubRoom) { unsubRoom(); unsubRoom = null; }
};

function listenRoom(roomId) {
  if (unsubRoom) { unsubRoom(); unsubRoom = null; }
  try {
    const q = query(collection(db,'rooms',roomId,'messages'), orderBy('createdAt','asc'));
    unsubRoom = onSnapshot(q, snap => {
      const msgs = [];
      snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
      renderMessages(msgs);
    });
  } catch(e) {}
}

function renderMessages(msgs) {
  const c = G('msglist');
  if (!msgs.length) {
    c.innerHTML = '<div class="empty" style="margin:auto;padding:30px 20px"><div class="ei" style="font-size:1.8rem">üí¨</div><p>Begin het gesprek!</p></div>';
    return;
  }
  const wasAtBottom = c.scrollHeight - c.scrollTop - c.clientHeight < 60;
  c.innerHTML = msgs.map(m => {
    const isMine = m.uid === me?.uid;
    const reactions = m.reactions || {};
    const reactSummary = buildReactSummary(reactions, m.id);
    return `<div class="mr ${isMine ? 'me' : ''}" id="msg-${m.id}">
      ${!isMine ? `<div class="mava">${ini(m.name)}</div>` : ''}
      <div class="mcol">
        ${!isMine ? `<div class="mname">${m.name}</div>` : ''}
        <div class="mbub" ondblclick="openReactPicker('${m.id}',this)">${escapeHTML(m.text)}</div>
        ${reactSummary}
        <div class="mtime">${ftm(m.createdAt)}</div>
      </div>
    </div>`;
  }).join('');
  if (wasAtBottom || msgs.length <= 5) c.scrollTop = c.scrollHeight;
}

function buildReactSummary(reactions, msgId) {
  if (!reactions || !Object.keys(reactions).length) {
    return `<div class="react-bar" id="rb-${msgId}"><button class="react-btn" style="opacity:.4" onclick="openReactPicker('${msgId}',this)">+ üòä</button></div>`;
  }
  // Aggregate by emoji
  const counts = {};
  Object.entries(reactions).forEach(([uid, emoji]) => {
    counts[emoji] = (counts[emoji] || []);
    counts[emoji].push(uid);
  });
  const btns = Object.entries(counts).map(([emoji, uids]) => {
    const mine = uids.includes(me?.uid);
    return `<button class="react-btn ${mine?'mine':''}" onclick="toggleReaction('${msgId}','${emoji}')">${emoji} ${uids.length}</button>`;
  }).join('');
  return `<div class="react-bar" id="rb-${msgId}">${btns}<button class="react-btn" style="opacity:.4" onclick="openReactPicker('${msgId}',this)">+</button></div>`;
}

const REACT_EMOJIS = ['‚ù§Ô∏è','üòÇ','üî•','üëç','üç∫','üòÆ','üò¢'];

window.openReactPicker = (msgId, el) => {
  // Close any open pickers first
  document.querySelectorAll('.react-picker.open').forEach(p => p.classList.remove('open'));
  const existing = document.getElementById('rpick-' + msgId);
  if (existing) { existing.classList.toggle('open'); return; }
  const picker = document.createElement('div');
  picker.className = 'react-picker open';
  picker.id = 'rpick-' + msgId;
  picker.innerHTML = REACT_EMOJIS.map(e => `<button class="react-pick-btn" onclick="toggleReaction('${msgId}','${e}');this.closest('.react-picker').classList.remove('open')">${e}</button>`).join('');
  const msgEl = document.getElementById('msg-' + msgId);
  if (msgEl) msgEl.querySelector('.mcol').style.position = 'relative', msgEl.querySelector('.mcol').appendChild(picker);
};

window.toggleReaction = async (msgId, emoji) => {
  if (!activeRoomId || !me) return;
  const msgRef = doc(db, 'rooms', activeRoomId, 'messages', msgId);
  const snap = await getDoc(msgRef);
  if (!snap.exists()) return;
  const reactions = snap.data().reactions || {};
  if (reactions[me.uid] === emoji) {
    delete reactions[me.uid]; // remove
  } else {
    reactions[me.uid] = emoji;
  }
  await updateDoc(msgRef, { reactions });
};

function escapeHTML(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Send button click AND Enter key
G('sndbtn').addEventListener('click', sendMsg);
G('msginput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } });

async function sendMsg() {
  if (!activeRoomId || !me) return;
  const inp = G('msginput');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  inp.focus();
  try {
    await addDoc(collection(db,'rooms',activeRoomId,'messages'), {
      text, uid: me.uid, name: me.displayName || 'Onbekend', createdAt: serverTimestamp(), reactions: {}
    });
    await updateDoc(doc(db,'rooms',activeRoomId), {
      lastMsg: text, lastAt: serverTimestamp(),
      lastSenderId: me.uid,
      [`unread.${me.uid}`]: 0  // reset own unread
    });
    // Increment unread for all other members
    const roomSnap = await getDoc(doc(db,'rooms',activeRoomId));
    if (roomSnap.exists()) {
      const members = roomSnap.data().members || [];
      const updates = {};
      members.filter(uid => uid !== me.uid).forEach(uid => {
        updates[`unread.${uid}`] = (roomSnap.data().unread?.[uid] || 0) + 1;
      });
      if (Object.keys(updates).length) await updateDoc(doc(db,'rooms',activeRoomId), updates);
    }
    checkBadgeProgress('send_message');
  } catch(e) { showToast('Kon bericht niet sturen: ' + e.message); }
}
window.sendMsg = sendMsg;

async function ensureDM(friendUid, friendName) {
  // Check if DM already exists
  try {
    const q = query(collection(db,'rooms'), where('type','==','dm'), where('members','array-contains', me.uid));
    const snap = await getDocs(q);
    for (const d of snap.docs) {
      if (d.data().members.includes(friendUid)) return d.id;
    }
  } catch(e) {}
  // Create new DM
  const ref = await addDoc(collection(db,'rooms'), {
    type: 'dm',
    name: friendName,
    members: [me.uid, friendUid],
    memberNames: [me.displayName || 'Ik', friendName || '?'],
    lastMsg: '', lastAt: serverTimestamp(), createdAt: serverTimestamp()
  });
  return ref.id;
}

// Group chat
function renderGroupPicker() {
  const picker = G('grppicker');
  const chips  = G('grpchips');
  picker.innerHTML = '';
  chips.innerHTML  = '';
  if (!myFriends.length) {
    picker.innerHTML = '<p style="font-size:.82rem;color:var(--tx2);padding:6px 0">Voeg eerst vrienden toe!</p>';
    return;
  }
  myFriends.forEach(f => {
    const sel = selMembers.includes(f.uid);
    const div = document.createElement('div');
    div.className = `fpi${sel ? ' sel' : ''}`;
    div.innerHTML = `<div class="fpia">${ini(f.name)}</div><span class="fpinm">${f.name}</span>${sel ? '<span class="fpck">‚úì</span>' : ''}`;
    div.onclick = () => {
      selMembers = sel ? selMembers.filter(u => u !== f.uid) : [...selMembers, f.uid];
      renderGroupPicker();
    };
    picker.appendChild(div);
  });
  selMembers.forEach(uid => {
    const f = myFriends.find(x => x.uid === uid); if (!f) return;
    const chip = document.createElement('span');
    chip.className = 'mch';
    chip.innerHTML = `${f.name} <span>‚úï</span>`;
    chip.onclick = () => { selMembers = selMembers.filter(u => u !== uid); renderGroupPicker(); };
    chips.appendChild(chip);
  });
}

window.createGroup = async () => {
  const name = G('grpname').value.trim();
  if (!name) { showToast('Geef de groep een naam!'); return; }
  if (!selMembers.length) { showToast('Voeg minstens √©√©n lid toe!'); return; }
  const members = [me.uid, ...selMembers];
  const memberNames = [me.displayName || 'Ik', ...selMembers.map(uid => myFriends.find(f => f.uid === uid)?.name || '?')];
  try {
    const ref = await addDoc(collection(db,'rooms'), {
      type: 'group', name, members, memberNames,
      lastMsg: '', lastAt: serverTimestamp(), createdAt: serverTimestamp(), createdBy: me.uid
    });
    closeModal('mogrp');
    G('grpname').value = '';
    selMembers = [];
    showToast('üë• Groepschat aangemaakt!');
    // auto open
    setTimeout(() => openRoom(ref.id, name, memberNames.join(', ')), 400);
  } catch(e) { showToast('Fout: ' + e.message); }
};

window.openNewGroup = async () => {
  selMembers = [];
  G('grpname').value = '';
  G('grpchips').innerHTML = '';
  G('grppicker').innerHTML = '<p style="font-size:.82rem;color:var(--tx2);padding:6px 0">Vrienden laden...</p>';
  openModal('mogrp');
  // reload friends fresh so picker is always up to date
  await loadFriends();
  renderGroupPicker();
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FRIENDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadFriends() {
  if (!me) return;
  myFriends = [];
  try {
    const [s1, s2] = await Promise.all([
      getDocs(query(collection(db,'friendRequests'), where('from','==',me.uid), where('status','==','accepted'))),
      getDocs(query(collection(db,'friendRequests'), where('to','==',me.uid),   where('status','==','accepted')))
    ]);
    s1.forEach(d => { const x=d.data(); myFriends.push({uid:x.to,   name:x.toName,   email:x.toEmail,   reqId:d.id}); });
    s2.forEach(d => { const x=d.data(); myFriends.push({uid:x.from, name:x.fromName, email:x.fromEmail, reqId:d.id}); });
    renderFriends();
    loadRequests();
  } catch(e) {}
}

function renderFriends() {
  const c = G('frlist');
  if (!myFriends.length) {
    c.innerHTML = '<div class="empty"><div class="ei">üë•</div><p>Nog geen vrienden.<br>Zoek iemand op via e-mail!</p></div>';
    return;
  }
  c.innerHTML = myFriends.map(f => `
    <div class="fri">
      <div class="fra">${ini(f.name)}</div>
      <div class="frin"><div class="frn">${f.name}</div><div class="fre">${f.email}</div></div>
      <div class="frbtns">
        <button class="btn bg_ bxs" onclick="openDM('${f.uid}','${f.name.replace(/'/g,"\\'")}')">üí¨</button>
        <button class="btn br_ bxs" onclick="unfriend('${f.reqId}','${f.name.replace(/'/g,"\\'")}')">‚úï</button>
      </div>
    </div>`).join('');
}

async function loadRequests() {
  if (!me) return;
  try {
    const snap = await getDocs(query(collection(db,'friendRequests'), where('to','==',me.uid), where('status','==','pending')));
    const sec = G('frreqsec'), list = G('frreqlist');
    if (snap.empty) { sec.style.display = 'none'; return; }
    sec.style.display = 'block';
    list.innerHTML = '';
    snap.forEach(d => {
      const x = d.data();
      const div = document.createElement('div');
      div.className = 'fri';
      div.innerHTML = `
        <div class="fra">${ini(x.fromName)}</div>
        <div class="frin"><div class="frn">${x.fromName}</div><div class="fre">${x.fromEmail}</div></div>
        <div class="frbtns">
          <button class="btn bgn bxs" onclick="acceptFr('${d.id}','${x.from}','${x.fromName.replace(/'/g,"\\'")}')">‚úì</button>
          <button class="btn br_ bxs" onclick="declineFr('${d.id}')">‚úï</button>
        </div>`;
      list.appendChild(div);
    });
  } catch(e) {}
}

window.searchFriend = async () => {
  const email = G('frsearch').value.trim().toLowerCase();
  if (!email) { showToast('Vul een e-mailadres in!'); return; }
  if (email === me.email?.toLowerCase()) { showToast('Dat ben jijzelf üòÑ'); return; }
  if (myFriends.find(f => f.email.toLowerCase() === email)) { showToast('Je bent al bevriend met deze persoon!'); return; }
  try {
    // check already sent
    const ex = await getDocs(query(collection(db,'friendRequests'), where('from','==',me.uid), where('toEmail','==',email), where('status','==','pending')));
    if (!ex.empty) { showToast('Je hebt al een verzoek gestuurd!'); return; }
    // find user
    const snap = await getDocs(query(collection(db,'users'), where('email','==',email)));
    if (snap.empty) { showToast('Geen gebruiker gevonden met dit e-mailadres.'); return; }
    const fd = snap.docs[0]; const fx = fd.data();
    // check reverse pending
    const rev = await getDocs(query(collection(db,'friendRequests'), where('from','==',fd.id), where('to','==',me.uid), where('status','==','pending')));
    if (!rev.empty) { showToast('Deze persoon heeft jou al een verzoek gestuurd! Check verzoeken.'); return; }
    await setDoc(doc(db,'friendRequests',`${me.uid}_${fd.id}`), {
      from:me.uid, fromName:me.displayName, fromEmail:me.email,
      to:fd.id, toName:fx.name, toEmail:fx.email,
      status:'pending', createdAt:serverTimestamp()
    });
    G('frsearch').value = '';
    showToast(`‚úâÔ∏è Verzoek verstuurd naar ${fx.name}!`);
  } catch(e) { showToast('Fout: ' + e.message); }
};

window.acceptFr = async (reqId, fromUid, fromName) => {
  try {
    await updateDoc(doc(db,'friendRequests',reqId), { status: 'accepted' });
    showToast(`üéâ ${fromName} toegevoegd als vriend!`);
    await loadFriends();
    await ensureDM(fromUid, fromName);
  } catch(e) { showToast('Fout: ' + e.message); }
};

window.declineFr = async reqId => {
  try { await updateDoc(doc(db,'friendRequests',reqId), { status: 'declined' }); loadFriends(); }
  catch(e) {}
};

window.unfriend = async (reqId, name) => {
  if (!confirm(`Wil je ${name} verwijderen als vriend?`)) return;
  try {
    await updateDoc(doc(db,'friendRequests',reqId), { status: 'removed' });
    showToast(`${name} verwijderd.`);
    loadFriends();
  } catch(e) { showToast('Fout: ' + e.message); }
};

window.openDM = async (uid, name) => {
  goTab('chat');
  try {
    const roomId = await ensureDM(uid, name);
    setTimeout(() => openRoom(roomId, name, 'Priv√©gesprek'), 350);
  } catch(e) { showToast('Kon gesprek niet openen: ' + e.message); }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENT MAPS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// cache of latest events for map tab
let latestEvents = [];

function renderEventMaps() {
  const c = G('evmaplist');
  const eventsWithLoc = latestEvents.filter(ev => ev.location && ev.location.trim());
  if (!eventsWithLoc.length) {
    c.innerHTML = '<div class="empty"><div class="ei">üìç</div><p>Nog geen events met locatie.<br>Maak een event aan met een adres!</p></div>';
    return;
  }
  c.innerHTML = eventsWithLoc.map(ev => {
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.location)}`;
    const osmUrl = `https://www.openstreetmap.org/search?query=${encodeURIComponent(ev.location)}`;
    return `<div class="card" style="margin-bottom:14px">
      <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:1rem;margin-bottom:4px">${ev.name}</div>
      <div style="font-size:.8rem;color:var(--tx2);margin-bottom:10px">üìç ${ev.location}</div>
      <iframe
        src="https://www.openstreetmap.org/export/embed.html?query=${encodeURIComponent(ev.location)}&layer=mapnik"
        style="width:100%;height:200px;border:0;border-radius:10px;margin-bottom:10px"
        loading="lazy"></iframe>
      <a href="${mapsUrl}" target="_blank" class="btn bg_ bsm">üó∫Ô∏è Open in Google Maps</a>
    </div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PHOTOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.uploadPhoto = inp => {
  const file = inp.files[0]; if (!file) return;
  const isVideo = file.type.startsWith('video/');
  const maxSize = isVideo ? 10 * 1024 * 1024 : 3 * 1024 * 1024;
  if (file.size > maxSize) { showToast(`${isVideo?'Video':'Foto'} mag max ${isVideo?'10':'3'}MB zijn!`); inp.value=''; return; }
  showToast('‚è≥ Uploaden...');
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      await addDoc(collection(db,'photos'), {
        url: e.target.result, uploadedBy: me.displayName,
        uid: me.uid, isVideo: isVideo, createdAt: serverTimestamp()
      });
      showToast(isVideo ? 'üé• Video gedeeld!' : 'üì∏ Foto gedeeld!');
      loadPhotos();
      if (isVideo) checkBadgeProgress('upload_video');
      else checkBadgeProgress('upload_photo');
    } catch(err) { showToast('Fout bij uploaden: ' + err.message); }
  };
  reader.readAsDataURL(file);
  inp.value = '';
};

async function loadPhotos() {
  if (!me) return;
  try {
    // No orderBy to avoid index requirement - sort client-side
    const snap = await getDocs(collection(db,'photos'));
    const grid = G('photogrid'), empty = G('phoempty');
    if (snap.empty) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
    empty.style.display = 'none';
    grid.innerHTML = '';
    const photos = [];
    snap.forEach(d => photos.push({ id: d.id, ...d.data() }));
    photos.sort((a, b) => {
      const ta = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
      const tb = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
      return tb - ta;
    });
    photos.forEach(data => {
      const cell = document.createElement('div');
      cell.className = 'pcell';
      if (data.isVideo) {
        const vid = document.createElement('video');
        vid.src = data.url; vid.muted = true; vid.playsInline = true; vid.preload = 'metadata';
        vid.addEventListener('mouseenter', () => vid.play());
        vid.addEventListener('mouseleave', () => { vid.pause(); vid.currentTime = 0; });
        vid.onclick = () => { G('photobig').src = ''; G('photobig').style.display='none';
          const bigVid = document.getElementById('photobigvid') || document.createElement('video');
          bigVid.id='photobigvid'; bigVid.src=data.url; bigVid.controls=true;
          bigVid.style='max-width:100%;max-height:80dvh;border-radius:var(--rl)';
          const ov = G('mophoto'); ov.innerHTML=''; ov.appendChild(bigVid); openModal('mophoto'); };
        cell.appendChild(vid);
        const badge = document.createElement('div');
        badge.className='media-type-badge'; badge.textContent='‚ñ∂ VIDEO';
        cell.appendChild(badge);
      } else {
        const img = document.createElement('img');
        img.src = data.url; img.alt = ''; img.loading = 'lazy';
        img.onclick = () => {
          const ov = G('mophoto');
          ov.innerHTML = `<img id="photobig" src="${data.url}" style="max-width:100%;max-height:80dvh;border-radius:var(--rl);box-shadow:0 16px 48px rgba(0,0,0,.8)">`;
          openModal('mophoto');
        };
        cell.appendChild(img);
      }
      // delete button
      if (data.uid === me.uid) {
        const del = document.createElement('button');
        del.className = 'pdel';
        del.innerHTML = 'üóë';
        del.title = 'Verwijderen';
        del.onclick = async (ev) => {
          ev.stopPropagation();
          if (!confirm('Verwijderen?')) return;
          try {
            await deleteDoc(doc(db,'photos', data.id));
            showToast('üóë Verwijderd.');
            loadPhotos();
          } catch(err) { showToast('Fout: ' + err.message); }
        };
        cell.appendChild(del);
      }
      grid.appendChild(cell);
    });
  } catch(e) { showToast('Fout bij laden foto\'s: ' + e.message); }
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PUSH-STYLE IN-APP NOTIFICATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let pnbRoomId = null;
let pnbRoomName = null;

function showPNB(title, msg, roomId, roomName) {
  G('pntitle').textContent = title;
  G('pnmsg').textContent = msg;
  pnbRoomId = roomId;
  pnbRoomName = roomName;
  const banner = G('pnbanner');
  banner.classList.add('show');
  if (pnbTimeout) clearTimeout(pnbTimeout);
  pnbTimeout = setTimeout(() => hidePNB(), 5000);
  // Also try native notification if permission granted
  if (Notification.permission === 'granted' && document.hidden) {
    new Notification(`Rounds ‚Äì ${title}`, { body: msg, icon: '/favicon.ico', tag: roomId });
  }
}

window.hidePNB = () => {
  G('pnbanner').classList.remove('show');
};

window.pnClick = () => {
  hidePNB();
  if (pnbRoomId) {
    goTab('chat');
    setTimeout(() => openRoom(pnbRoomId, pnbRoomName, ''), 300);
  }
};

function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    setTimeout(() => {
      Notification.requestPermission().then(p => {
        if (p === 'granted') showToast('üîî Notificaties ingeschakeld!');
      });
    }, 3000);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DELETE EVENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.deleteEvent = async (evId) => {
  if (!confirm('Event verwijderen?')) return;
  try {
    await deleteDoc(doc(db, 'events', evId));
    showToast('üóë Event verwijderd.');
  } catch(e) { showToast('Fout: ' + e.message); }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RSVP LIST MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.openRsvpModal = async (evId) => {
  const evSnap = await getDoc(doc(db,'events',evId));
  if (!evSnap.exists()) return;
  const ev = evSnap.data();
  currentRsvpEvData = { id: evId, ...ev };
  G('rsvp-modal-title').textContent = ev.name;
  const rsvps = ev.rsvps || {};
  const yesUids = Object.entries(rsvps).filter(([,v]) => v==='yes').map(([k]) => k);
  const mayUids = Object.entries(rsvps).filter(([,v]) => v==='maybe').map(([k]) => k);
  const noUids  = Object.entries(rsvps).filter(([,v]) => v==='no').map(([k]) => k);
  G('rsvp-yes-count').textContent = yesUids.length;
  G('rsvp-maybe-count').textContent = mayUids.length;
  G('rsvp-no-count').textContent = noUids.length;
  currentRsvpTab = 'yes';
  await renderRsvpList(yesUids);
  openModal('morsvp');
};

window.showRsvpTab = async (tab) => {
  currentRsvpTab = tab;
  if (!currentRsvpEvData) return;
  const rsvps = currentRsvpEvData.rsvps || {};
  const uids = Object.entries(rsvps).filter(([,v]) => v===tab).map(([k]) => k);
  await renderRsvpList(uids);
};

async function renderRsvpList(uids) {
  const c = G('rsvp-modal-list');
  if (!uids.length) { c.innerHTML = '<div style="text-align:center;color:var(--tx2);padding:16px;font-size:.85rem">Niemand in deze categorie</div>'; return; }
  c.innerHTML = '<div style="text-align:center;color:var(--tx2);font-size:.8rem;padding:8px">Laden...</div>';
  const statusIcon = { yes: '‚úÖ', maybe: 'ü§î', no: '‚ùå' };
  const rows = await Promise.all(uids.map(async uid => {
    const usnap = await getDoc(doc(db,'users',uid));
    const name = usnap.exists() ? usnap.data().name : '?';
    return `<div class="rsvp-user">
      <div class="rsvp-av">${ini(name)}</div>
      <div class="rsvp-nm">${name}</div>
      <div class="rsvp-status">${statusIcon[currentRsvpTab]}</div>
    </div>`;
  }));
  c.innerHTML = rows.join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENT CHAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.openEvtChat = (evId, evName) => {
  if (unsubEvtChat) { unsubEvtChat(); unsubEvtChat = null; }
  activeEvtChatId = evId;
  G('evtchat-title').textContent = 'üí¨ ' + evName;
  G('evtchat-msgs').innerHTML = '';
  openModal('moevtchat');
  G('evtchat-inp').addEventListener('keydown', e => { if (e.key==='Enter') sendEvtChatMsg(); }, {once:false});
  const q = query(collection(db,'events',evId,'chat'), orderBy('createdAt','asc'));
  unsubEvtChat = onSnapshot(q, snap => {
    const msgs = [];
    snap.forEach(d => msgs.push({id:d.id,...d.data()}));
    const c = G('evtchat-msgs');
    if (!msgs.length) { c.innerHTML='<div style="text-align:center;color:var(--tx2);font-size:.8rem;padding:12px">Begin het gesprek!</div>'; return; }
    const wasBottom = c.scrollHeight - c.scrollTop - c.clientHeight < 60;
    c.innerHTML = msgs.map(m => {
      const isMine = m.uid === me?.uid;
      return `<div class="mr ${isMine?'me':''}">
        ${!isMine ? `<div class="mava">${ini(m.name)}</div>` : ''}
        <div class="mcol">
          ${!isMine ? `<div class="mname">${m.name}</div>` : ''}
          <div class="mbub">${escapeHTML(m.text)}</div>
          <div class="mtime">${ftm(m.createdAt)}</div>
        </div>
      </div>`;
    }).join('');
    if (wasBottom) c.scrollTop = c.scrollHeight;
  });
};

window.sendEvtChatMsg = async () => {
  if (!activeEvtChatId || !me) return;
  const inp = G('evtchat-inp');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  try {
    await addDoc(collection(db,'events',activeEvtChatId,'chat'), {
      text, uid: me.uid, name: me.displayName || 'Onbekend', createdAt: serverTimestamp()
    });
  } catch(e) { showToast('Fout: ' + e.message); }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE LOCATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.toggleShareLocation = () => {
  if (!navigator.geolocation) { showToast('Geolocatie niet beschikbaar'); return; }
  showToast('üìç Locatie delen gestart...');
  G('shareloc-btn').style.display = 'none';
  G('stoploc-btn').style.display = 'inline-flex';
  locWatchId = navigator.geolocation.watchPosition(async pos => {
    try {
      await setDoc(doc(db,'liveLocations',me.uid), {
        uid: me.uid, name: me.displayName, lat: pos.coords.latitude,
        lng: pos.coords.longitude, updatedAt: serverTimestamp()
      });
    } catch(e) {}
  }, () => {
    showToast('‚ùå Geen toegang tot locatie');
    stopShareLocation();
  }, { enableHighAccuracy: true, maximumAge: 10000 });
};

window.stopShareLocation = async () => {
  if (locWatchId !== null) { navigator.geolocation.clearWatch(locWatchId); locWatchId = null; }
  G('shareloc-btn').style.display = 'inline-flex';
  G('stoploc-btn').style.display = 'none';
  try { await deleteDoc(doc(db,'liveLocations',me.uid)); } catch(e) {}
  showToast('üìç Locatie delen gestopt');
};

function startLiveLocations() {
  if (unsubLiveLoc) unsubLiveLoc();
  unsubLiveLoc = onSnapshot(collection(db,'liveLocations'), snap => {
    const locs = [];
    snap.forEach(d => locs.push({id:d.id,...d.data()}));
    // Show only friends
    const friendUids = myFriends.map(f => f.uid);
    const visible = locs.filter(l => friendUids.includes(l.uid) || l.uid === me?.uid);
    const c = G('liveloc-list');
    if (!visible.length) {
      c.innerHTML = '<div style="font-size:.8rem;color:var(--tx2);padding:8px 0">Niemand deelt momenteel een locatie.</div>';
      return;
    }
    c.innerHTML = visible.map(l => {
      const mapsUrl = `https://www.google.com/maps?q=${l.lat},${l.lng}`;
      return `<div class="loc-item">
        <span class="loc-dot"></span>
        <div class="loc-name">${l.uid===me?.uid?'Jij':l.name}</div>
        <a href="${mapsUrl}" target="_blank" class="btn bg_ bxs">üó∫Ô∏è</a>
      </div>`;
    }).join('');
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PROFILE PHOTO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.uploadProfilePhoto = inp => {
  const file = inp.files[0]; if (!file) return;
  if (file.size > 2 * 1024 * 1024) { showToast('Foto mag max 2MB zijn!'); inp.value=''; return; }
  showToast('‚è≥ Profielfoto uploaden...');
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      await updateDoc(doc(db,'users',me.uid), { photoURL: e.target.result });
      const photoData = e.target.result;
      G('profav').innerHTML = `<img src="${photoData}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`;
      G('hav').innerHTML = `<img src="${photoData}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">`;
      showToast('üì∏ Profielfoto bijgewerkt!');
    } catch(err) { showToast('Fout: ' + err.message); }
  };
  reader.readAsDataURL(file);
  inp.value = '';
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DELETE ACCOUNT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.confirmDeleteAccount = async () => {
  const pw = prompt('Voer je wachtwoord in om je account te verwijderen:');
  if (!pw) return;
  try {
    const cred = EmailAuthProvider.credential(me.email, pw);
    await reauthenticateWithCredential(me, cred);
    if (!confirm('Weet je het zeker? Dit kan niet ongedaan worden!')) return;
    // Clean up user data
    await updateDoc(doc(db,'users',me.uid), { deleted: true, name: 'Verwijderde gebruiker' });
    try { await deleteDoc(doc(db,'liveLocations',me.uid)); } catch(e) {}
    await deleteUser(me);
    showToast('Account verwijderd.');
  } catch(e) {
    if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
      showToast('‚ùå Verkeerd wachtwoord.');
    } else {
      showToast('Fout: ' + e.message);
    }
  }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BADGES & CHALLENGES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CHALLENGES = [
  { id: 'first_message',  name: 'Eerste bericht',  emoji: 'üí¨', desc: 'Stuur je eerste bericht', goal: 1,  track: 'send_message' },
  { id: 'chat10',         name: 'Chatterbox',       emoji: 'üó£Ô∏è', desc: 'Stuur 10 berichten',    goal: 10, track: 'send_message' },
  { id: 'first_event',    name: 'Organisator',      emoji: 'üéâ', desc: 'Maak je eerste event',  goal: 1,  track: 'create_event' },
  { id: 'first_rsvp',     name: 'Aanwezig!',        emoji: '‚úÖ', desc: 'RSVP je eerste event',  goal: 1,  track: 'rsvp_yes' },
  { id: 'first_photo',    name: 'Fotograaf',        emoji: 'üì∏', desc: 'Upload een foto',       goal: 1,  track: 'upload_photo' },
  { id: 'first_video',    name: 'Cameraman',        emoji: 'üé•', desc: 'Upload een video',      goal: 1,  track: 'upload_video' },
  { id: 'first_location', name: 'Op de radar',      emoji: 'üìç', desc: 'Deel je locatie',       goal: 1,  track: 'share_location' },
  { id: 'social5',        name: 'Sociaal vlinder',  emoji: 'ü¶ã', desc: 'Voeg 5 vrienden toe',   goal: 5,  track: 'add_friend' },
  { id: 'react_master',   name: 'Reactor',          emoji: 'üî•', desc: 'Reageer op 5 berichten',goal: 5,  track: 'react' },
];

async function loadBadges() {
  if (!me) return;
  try {
    const snap = await getDoc(doc(db,'userProgress',me.uid));
    const progress = snap.exists() ? snap.data() : {};
    myBadges = CHALLENGES.filter(c => (progress[c.track] || 0) >= c.goal).map(c => c.id);
    renderProfileBadges();
    renderChallenges(progress);
  } catch(e) {}
}

function renderProfileBadges() {
  const c = G('prof-badges');
  if (!c) return;
  c.innerHTML = CHALLENGES.map(ch => {
    const earned = myBadges.includes(ch.id);
    return `<div class="bdg-item ${earned?'earned':''}">
      <span class="bdg-icon">${ch.emoji}</span>
      <div class="bdg-name">${ch.name}</div>
      ${!earned ? '<span class="bdg-lock">üîí</span>' : ''}
    </div>`;
  }).join('');
}

function renderChallenges(progress) {
  const c = G('challenges-list');
  if (!c) return;
  c.innerHTML = CHALLENGES.map(ch => {
    const cur = Math.min(progress[ch.track] || 0, ch.goal);
    const pct = Math.round((cur / ch.goal) * 100);
    const done = cur >= ch.goal;
    return `<div class="chal-item">
      <div class="chal-icon">${ch.emoji}</div>
      <div class="chal-info">
        <div class="chal-name">${ch.name} ${done?'‚úÖ':''}</div>
        <div class="chal-desc">${ch.desc} (${cur}/${ch.goal})</div>
        <div class="chal-prog"><div class="chal-prog-bar" style="width:${pct}%"></div></div>
      </div>
    </div>`;
  }).join('');
}

async function checkBadgeProgress(track, amount = 1) {
  if (!me) return;
  try {
    const ref = doc(db,'userProgress',me.uid);
    const snap = await getDoc(ref);
    const progress = snap.exists() ? snap.data() : {};
    const newVal = (progress[track] || 0) + amount;
    await setDoc(ref, { [track]: newVal }, { merge: true });
    // Check if any badge newly earned
    const prev = progress[track] || 0;
    CHALLENGES.filter(c => c.track === track && prev < c.goal && newVal >= c.goal).forEach(c => {
      showToast(`üèÜ Badge verdiend: ${c.emoji} ${c.name}!`, 4000);
    });
    loadBadges();
  } catch(e) {}
}

// Hook rsvp to badge system
const _origRsvp = window.rsvp;
window.rsvp = async (evId, status) => {
  await _origRsvp(evId, status);
  if (status === 'yes') checkBadgeProgress('rsvp_yes');
};

// Hook acceptFr to badge system
const _origAcceptFr = window.acceptFr;
window.acceptFr = async (reqId, fromUid, fromName) => {
  await _origAcceptFr(reqId, fromUid, fromName);
  checkBadgeProgress('add_friend');
};

// Hook submitEvent
const _origSubmitEvent = window.submitEvent;
window.submitEvent = async () => {
  await _origSubmitEvent();
  checkBadgeProgress('create_event');
};

// Hook toggleShareLocation
const _origToggleLoc = window.toggleShareLocation;
window.toggleShareLocation = () => {
  _origToggleLoc();
  checkBadgeProgress('share_location');
};

// Hook toggleReaction
const _origToggleReact = window.toggleReaction;
window.toggleReaction = async (msgId, emoji) => {
  await _origToggleReact(msgId, emoji);
  checkBadgeProgress('react');
};

</script>
</body>
</html>
